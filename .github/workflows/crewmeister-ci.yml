name: crewmeister-ci

on:
  push:
    branches:
      - main
      - feature/*

permissions:
  id-token: write
  contents: read

jobs:
  auth:
    runs-on: ubuntu-latest
    outputs:
      aws_access_key_id: ${{ steps.auth.outputs.aws_access_key_id }}
      aws_secret_access_key: ${{ steps.auth.outputs.aws_secret_access_key }}
      aws_session_token: ${{ steps.auth.outputs.aws_session_token }}
    steps:
      - name: Configure AWS Credentials (OIDC)
        id: auth
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Verify AWS Identity
        run: aws sts get-caller-identity

  deploy:
    runs-on: ubuntu-latest
    needs: auth  # Depend on authentication job
    env:
      AWS_ACCESS_KEY_ID: ${{ needs.auth.outputs.aws_access_key_id }}
      AWS_SECRET_ACCESS_KEY: ${{ needs.auth.outputs.aws_secret_access_key }}
      AWS_SESSION_TOKEN: ${{ needs.auth.outputs.aws_session_token }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Use AWS Credentials in Other Jobs
        run: |
          aws sts get-caller-identity
          aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }} --role-arn ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy Helm Chart
        run: |
          helm upgrade --install crewmeister-app helm/crewmeister-app \
            --namespace default \
            --create-namespace \
            --values helm/crewmeister-app/values.yaml \
            --timeout 10m \
            --debug \
            --wait
