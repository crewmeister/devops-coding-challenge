name: crewmeister-ci

on:
  push:
    branches:
      - main
      - feature/*

permissions:
  id-token: write
  contents: read

jobs:
  auth:
    runs-on: ubuntu-latest
    outputs:
      aws_access_key_id: ${{ steps.auth.outputs.aws_access_key_id }}
      aws_secret_access_key: ${{ steps.auth.outputs.aws_secret_access_key }}
      aws_session_token: ${{ steps.auth.outputs.aws_session_token }}
    steps:

      - name: Checkout Code
        uses: actions/checkout@v3
    
      - name: Configure AWS Credentials (OIDC)
        id: auth
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Verify AWS Identity
        run: aws sts get-caller-identity

      - name: Use AWS Credentials in Other Jobs
        run: |
          aws sts get-caller-identity
          aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }} 

      - name: Verify Helm Installation
        run: |
          helm version

      - name: Debug Working Directory
        run: pwd && ls -la
      
      - name: Check Helm Chart Path
        run: ls -R helm/
  
      
      - name: Deploy Helm Chart (Debug)
        run: |
          helm upgrade --install crewmeister-app ./helm/crewmeister-app \
  
        
